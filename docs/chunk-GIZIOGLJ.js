import{B as x,E as T,H as l,b as F,c as D,d as b,f as L,g as w,h as g,i as j,j as P,lb as p,mb as c,nb as W,q as _,t as K,u as B}from"./chunk-N7OEIV7C.js";var u=class{static put(s,e){sessionStorage.setItem(s,JSON.stringify(e))}static get(s){let e=sessionStorage.getItem(s);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.warn(`Cannot parse ${s} as JSON`,t),e}}static remove(s){sessionStorage.removeItem(s)}};var C=class{static put(s,e){localStorage.setItem(s,JSON.stringify(e))}static get(s){let e=localStorage.getItem(s);if(!e)return null;try{return JSON.parse(e)}catch(t){return console.warn(`Cannot parse ${s} as JSON`,t),e}}static remove(s){localStorage.removeItem(s)}};var O=class n{static decode(s){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="";if(s=String(s).replace(/=+$/,""),s.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let i=0,o,r,h=0;r=s.charAt(h++);~r&&(o=i%4?o*64+r:r,i++%4)?t+=String.fromCharCode(255&o>>(-2*i&6)):0)r=e.indexOf(r);return t}static decodeUnicode(s){let e=t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2);return decodeURIComponent(Array.prototype.map.call(n.decode(s),e).join(""))}static urlDecode(s){let e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("Illegal base64url string!")}return n.decodeUnicode(e)}static urlEncode(s){return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}};var m=class n{static decodeToken(s){if(!s||s==="")return null;let e=s.split(".");if(e.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let t=O.urlDecode(e[1]);if(!t)throw new Error("Cannot decode the token.");return JSON.parse(t)}static getTokenExpirationDate(s){let e=n.decodeToken(s);if(!e||!e.hasOwnProperty("exp"))return null;let t=new Date(0);return t.setUTCSeconds(e.exp),t}static isTokenExpired(s,e){if(!s||s==="")return!0;let t=n.getTokenExpirationDate(s);return e=e||0,t===null?!1:!(t.valueOf()>new Date().valueOf()+e*1e3)}static getTokenClientId(s){let e=n.decodeToken(s);return!e||!e.hasOwnProperty("client_id")?null:e.client_id}};var a=function(n){return n.PASSWORD="PASSWORD",n.IMPLICIT="IMPLICIT",n.AUTHORIZATION_CODE="AUTHORIZATION_CODE",n.CLIENT_CREDENTIALS="CLIENT_CREDENTIALS",n}(a||{}),f=class{constructor(s,e){this.type=s,this.clientId=e&&e.clientId||null,this.scope=e&&e.scope||null,this.resource=e&&e.resource||null}};function V(n){return n=n||{},{accessToken:n.access_token||n.accessToken||null,refreshToken:n.refresh_token||n.refreshToken||null}}var y=class{constructor(s){this.mapper=s&&s.mapper||V}};var N=class extends f{constructor(s){super(a.PASSWORD,s),this.tokenUrl=s&&s.tokenUrl||null,this.clientSecret=s&&s.clientSecret||null,this.useHttpBasicAuth=s&&s.useHttpBasicAuth||!0}};var A=class extends f{constructor(s){super(a.AUTHORIZATION_CODE,s),this.loginUrl=s&&s.loginUrl||null,this.tokenUrl=s&&s.tokenUrl||null,this.clientSecret=s&&s.clientSecret||null,this.useHttpBasicAuth=s&&s.useHttpBasicAuth||!0,this.responseType=s&&s.responseType||"code",this.preventClearHashAfterLogin=s&&s.preventClearHashAfterLogin||!1,this.disablePKCE=s&&s.disablePKCE||null}};var U=class extends f{constructor(s){super(a.CLIENT_CREDENTIALS,s),this.tokenUrl=s&&s.tokenUrl||null,this.clientSecret=s&&s.clientSecret||null,this.useHttpBasicAuth=s&&s.useHttpBasicAuth||!0}};var I=(()=>{class n{static{this.ACCESS_TOKEN_KEY="access_token"}static{this.REFRESH_TOKEN_KEY="refresh_token"}constructor(e,t,i,o,r){this.http=e,this.options=t,this.passwordFlowOptions=i,this.authorizationCodeFlowOptions=o,this.clientCredentialsFlowOptions=r,this.accessToken=new b(u.get(n.ACCESS_TOKEN_KEY)),this.refreshToken=new b(C.get(n.REFRESH_TOKEN_KEY)),this.accessTokenPending=null,this.accessToken$=this.accessToken.asObservable(),this.refreshToken$=this.refreshToken.asObservable()}ngOnDestroy(){this.accessTokenPending&&this.accessTokenPending.complete(),this.accessToken.complete(),this.refreshToken.complete()}setAccessToken(e){u.put(n.ACCESS_TOKEN_KEY,e),this.accessToken.next(e)}setRefreshToken(e){C.put(n.REFRESH_TOKEN_KEY,e),this.refreshToken.next(e)}setTokens(e,t){this.setAccessToken(e),this.setRefreshToken(t)}getAccessToken(){return this.accessToken.getValue()}getRefreshToken(){return this.refreshToken.getValue()}getAuthenticationFlowType(e=this.getAccessToken()){let t=m.getTokenClientId(e);return t?this.passwordFlowOptions.clientId===t?a.PASSWORD:this.authorizationCodeFlowOptions.clientId===t?a.AUTHORIZATION_CODE:this.clientCredentialsFlowOptions.clientId===t?a.CLIENT_CREDENTIALS:null:null}hasValidAccessToken(e){let t=this.getAccessToken();return t&&!m.isTokenExpired(t,e)}hasValidRefreshToken(e){let t=this.getRefreshToken();return t&&!m.isTokenExpired(t,e)}getValidAccessToken(){return this.accessTokenPending&&!this.accessTokenPending.isStopped?this.accessTokenPending.pipe(B(),P(()=>this.accessToken$.pipe(_(1)))):(this.accessTokenPending=new D,j([this.accessToken$,this.refreshToken$]).pipe(P(([e,t])=>!e&&!t?w({message:"Authentication token is missing"}):e?m.isTokenExpired(e)?this.getAuthenticationFlowType(e)===a.CLIENT_CREDENTIALS?this.authenticateWithClientCredentials().pipe(g(i=>i.accessToken)):t?m.isTokenExpired(t)?w({message:"Refresh token expired",details:"Cannot obtain new access token"}):this.authenticateWithRefreshToken(t).pipe(g(i=>i.accessToken)):w({message:"Access token expired",details:"No refresh token to obtain new access token"}):L(e):m.isTokenExpired(t)?w({message:"Access token is missing",details:"Refresh token expired - cannot obtain new access token"}):this.authenticateWithRefreshToken(t).pipe(g(i=>i.accessToken))),_(1),K(()=>{this.accessTokenPending.next(),this.accessTokenPending.complete()})))}authenticateWithPassword(e,t,i=new c,o=new p){return i=(i||new c).set("username",e).set("password",t).set("grant_type","password"),o=(o||new p).set("Content-Type","application/x-www-form-urlencoded"),this.passwordFlowOptions.useHttpBasicAuth&&(o=o.set("Authorization",`Basic ${btoa(`${this.passwordFlowOptions.clientId}:${this.passwordFlowOptions.clientSecret}`)}`)),this.http.post(this.passwordFlowOptions.tokenUrl,i,{headers:o}).pipe(g(r=>this.transform(r)),x(r=>this.setTokens(r.accessToken||null,r.refreshToken||null)))}authenticateWithRefreshToken(e,t=new c,i=new p){if(!e)return w({message:"Refresh token must not be empty"});t=(t||new c).set("grant_type","refresh_token").set("refresh_token",e),i=(i||new p).set("Content-Type","application/x-www-form-urlencoded");let o=null,r=null,h=null,d=null;switch(this.getAuthenticationFlowType(e)){case a.PASSWORD:o=this.passwordFlowOptions.tokenUrl,r=this.passwordFlowOptions.clientId,h=this.passwordFlowOptions.clientSecret,d=this.passwordFlowOptions.useHttpBasicAuth;break;case a.AUTHORIZATION_CODE:o=this.authorizationCodeFlowOptions.tokenUrl,r=this.authorizationCodeFlowOptions.clientId,h=this.authorizationCodeFlowOptions.clientSecret,d=this.authorizationCodeFlowOptions.useHttpBasicAuth;break;case a.CLIENT_CREDENTIALS:o=this.clientCredentialsFlowOptions.tokenUrl,r=this.clientCredentialsFlowOptions.clientId,h=this.clientCredentialsFlowOptions.clientSecret,d=this.clientCredentialsFlowOptions.useHttpBasicAuth;break;default:return w({message:"Refresh token authentication is not supported"})}return o?(h&&d&&(i=i.set("Authorization",`Basic ${btoa(`${r}:${h}`)}`)),this.http.post(o,t,{headers:i}).pipe(g(k=>this.transform(k)),x(k=>this.setTokens(k.accessToken||null,k.refreshToken||null)))):w({message:"Refresh token not supported"})}authenticateWithAuthorizationCode(e,t=new c,i=new p){return t=(t||new c).set("grant_type","authorization_code").set("code",e),i=(i||new p).set("Content-Type","application/x-www-form-urlencoded"),this.authorizationCodeFlowOptions.useHttpBasicAuth?i=i.set("Authorization",`Basic ${btoa(`${this.authorizationCodeFlowOptions.clientId}:${this.authorizationCodeFlowOptions.clientSecret}`)}`):(t=t.set("client_id",this.authorizationCodeFlowOptions.clientId),this.authorizationCodeFlowOptions.clientSecret&&(t=t.set("client_secret",this.authorizationCodeFlowOptions.clientSecret))),this.http.post(this.authorizationCodeFlowOptions.tokenUrl,t,{headers:i}).pipe(g(o=>this.transform(o)),x(o=>this.setTokens(o.accessToken||null,o.refreshToken||null)))}authenticateWithClientCredentials(e=new c,t=new p){return e=(e||new c).set("grant_type","client_credentials"),t=(t||new p).set("Content-Type","application/x-www-form-urlencoded"),this.clientCredentialsFlowOptions.useHttpBasicAuth&&(t=t.set("Authorization",`Basic ${btoa(`${this.clientCredentialsFlowOptions.clientId}:${this.clientCredentialsFlowOptions.clientSecret}`)}`)),this.http.post(this.clientCredentialsFlowOptions.tokenUrl,e,{headers:t}).pipe(g(i=>this.transform(i)),x(i=>this.setTokens(i.accessToken||null,i.refreshToken||null)))}clear(){this.accessToken.next(null),u.remove(n.ACCESS_TOKEN_KEY),this.refreshToken.next(null),C.remove(n.REFRESH_TOKEN_KEY)}transform(e){return this.options.mapper(e)}static{this.\u0275fac=function(t){return new(t||n)(l(W),l(y),l(N),l(A),l(U))}}static{this.\u0275prov=T({token:n,factory:n.\u0275fac})}}return n})();var fe=(()=>{class n{constructor(e){this.tokens=e}authenticate(e,t,i=new c,o=new p){return this.tokens.authenticateWithPassword(e,t,i,o)}clear(){this.tokens.clear()}static{this.\u0275fac=function(t){return new(t||n)(l(I))}}static{this.\u0275prov=T({token:n,factory:n.\u0275fac})}}return n})();var E=class n{static getHashFragmentParams(s){let e=s||window.location.hash;if(e=decodeURIComponent(e),e.indexOf("#")!==0)return{};let t=e.indexOf("?");return t>-1?e=e.substr(t+1):e=e.substr(1),n.parseQueryString(e)}static parseQueryString(s){let e={},t,i,o,r,h,d,k;if(s===null)return e;t=s.split("&");for(let H=0;H<t.length;H++)i=t[H],o=i.indexOf("="),o===-1?(r=i,h=null):(r=i.substr(0,o),h=i.substr(o+1)),d=decodeURIComponent(r),k=decodeURIComponent(h),d.substr(0,1)==="/"&&(d=d.substr(1)),e[d]=k;return e}static getCodePartsFromUrl(s){return!s||s.length===0?n.getHashFragmentParams():(s.charAt(0)==="?"&&(s=s.substr(1)),n.parseQueryString(s))}};var S=class n{static createNonce(){let s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",e=45,t="",i=typeof self>"u"?null:self.crypto||self.msCrypto;if(i){let o=new Uint8Array(e);i.getRandomValues(o),o=o.map(r=>s.charCodeAt(r%s.length)),t=String.fromCharCode.apply(null,o)}else for(;0<e--;)t+=s[Math.random()*s.length|0];return O.urlEncode(t)}static createAndSaveNonce(){let s=n.createNonce();return u.put("nonce",s),s}};var R=class extends f{constructor(s){super(a.IMPLICIT,s),this.loginUrl=s&&s.loginUrl||null,this.responseType=s&&s.responseType||"token",this.preventClearHashAfterLogin=s&&s.preventClearHashAfterLogin||!1}};var xe=(()=>{class n{constructor(e,t){this.tokens=e,this.options=t}initialize(e=!1){return new F(t=>{if(this.tokens.hasValidAccessToken()){t.next({message:"Access token is still valid"}),t.complete();return}let{access_token:i,state:o,error:r}=E.getHashFragmentParams();if(r){t.error({message:r});return}if(!i&&!o&&e){t.next({message:"No access token and authenticate automatically is set to true - you will be redirected"}),t.complete(),this.authenticate();return}if(!i){t.error({message:"No access token in URL"});return}if(!o){t.error({message:"Nonce is missing"});return}if(o!==u.get("nonce")){t.error({message:"Nonce is not valid"});return}this.tokens.setAccessToken(i),t.next({message:"Access token saved"}),t.complete(),this.options.preventClearHashAfterLogin||(location.hash="")})}authenticate(e=document.location.href,t=!1,i=new c){document.location.href=this.loginUrl(e,t,i)}loginUrl(e,t=!1,i=new c){let o=S.createAndSaveNonce();return i=(i||new c).set("client_id",this.options.clientId).set("state",o).set("response_type",this.options.responseType).set("redirect_uri",e),this.options.scope&&(i=i.set("scope",this.options.scope)),this.options.resource&&(i=i.set("resource",this.options.resource)),t&&(i=i.set("prompt","none")),`${this.options.loginUrl}?${i.toString()}`}clear(){this.tokens.clear()}static{this.\u0275fac=function(t){return new(t||n)(l(I),l(R))}}static{this.\u0275prov=T({token:n,factory:n.\u0275fac})}}return n})();var be=(()=>{class n{constructor(e,t){this.tokens=e,this.options=t}initialize(e=!1){return new F(t=>{if(this.tokens.hasValidAccessToken()){t.next({message:"Access is still valid"}),t.complete();return}let{code:i,state:o,error:r}=E.getCodePartsFromUrl(window.location.search);if(!this.options.preventClearHashAfterLogin){let h=location.href.replace(/[&?]code=[^&$]*/,"").replace(/[&?]scope=[^&$]*/,"").replace(/[&?]state=[^&$]*/,"").replace(/[&?]session_state=[^&$]*/,"");history.replaceState(null,window.name,h)}if(r){t.error({message:r});return}if(!i&&!o&&e){t.next({message:"No code and authenticate automatically is set to true - you will be redirected"}),t.complete(),this.authenticate();return}if(!o){t.error({message:"Nonce is missing"});return}if(o!==u.get("nonce")){t.error({message:"Nonce is not valid"});return}if(!i){t.error({message:"Code is missing"});return}this.getTokenFromCode(i).subscribe(()=>{t.next({message:"Tokens  saved"}),t.complete()},t.error)})}authenticate(e=document.location.href,t=!1,i=new c){document.location.href=this.loginUrl(e,t,i)}loginUrl(e,t=!1,i=new c){let o=S.createAndSaveNonce();return i=(i||new c).set("client_id",this.options.clientId).set("state",o).set("response_type",this.options.responseType).set("redirect_uri",e),this.options.scope&&(i=i.set("scope",this.options.scope)),this.options.resource&&(i=i.set("resource",this.options.resource)),t&&(i=i.set("prompt","none")),`${this.options.loginUrl}?${i.toString()}`}clear(){this.tokens.clear()}getTokenFromCode(e){let t=new c;if(!this.options.disablePKCE){let i=u.get("PKCI_verifier");i?t=t.set("code_verifier",i):console.warn("No PKCI verifier found in storage!")}return this.tokens.authenticateWithAuthorizationCode(e,t)}static{this.\u0275fac=function(t){return new(t||n)(l(I),l(A))}}static{this.\u0275prov=T({token:n,factory:n.\u0275fac})}}return n})();export{m as a,a as b,y as c,N as d,A as e,U as f,I as g,R as h,fe as i,xe as j,be as k};
